name: Deploy to Ubuntu Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "➡️ Masuk ke direktori aplikasi"
            cd ${{ secrets.APP_PATH }}

            echo "🔄 Menarik perubahan terbaru dari Git"
            git pull origin main

            echo "📦 Memastikan .bashrc dijalankan untuk akses node, pnpm, dan pm2"
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            fi

            echo "📍 Menyeting PATH untuk pnpm jika diperlukan"
            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH:$PATH"

            echo "📥 Menginstall dependensi"
            pnpm install

            echo "🏗️ Membuild project"
            pnpm build

            echo "📄 Menyalin file .env ke dalam dist/"
            cp .env dist/.env

            echo "🚦 Menjalankan atau me-restart aplikasi menggunakan PM2"
            pm2 describe patrol-be > /dev/null

            if [ $? -eq 0 ]; then
              echo "🔁 Restarting existing PM2 process..."
              pm2 restart patrol-be --update-env
            else
              echo "🚀 Starting new PM2 process with pnpm start"
              pm2 start pnpm --name "patrol-be" -- start
            fi
